-- 1. Athletes born after the year 2000 who won a medal, showing their highest medal

WITH RankedMedals AS (
  SELECT
    a.AthleteID,
    a.AthleteName,
    a.Gender,
    c.CountryName,
    DATE_PART('year', AGE(CURRENT_DATE, a.Birthday)) AS Age,
    MAX(CASE
          WHEN r.Medal = 'Gold' THEN 3
          WHEN r.Medal = 'Silver' THEN 2
          WHEN r.Medal = 'Bronze' THEN 1
        END) AS BestMedalScore
  FROM Athlete a
  JOIN Relationship r ON a.AthleteID = r.AthleteID
  JOIN Country c ON a.CountryId = c.CountryId
  WHERE EXTRACT(YEAR FROM a.Birthday) > 2000 AND r.Medal IS NOT NULL
  GROUP BY a.AthleteID, a.AthleteName, a.Gender, c.CountryName, a.Birthday
)
SELECT
  AthleteName,
  Gender,
  CountryName,
  Age,
  CASE BestMedalScore
    WHEN 3 THEN 'Gold'
    WHEN 2 THEN 'Silver'
    WHEN 1 THEN 'Bronze'
  END AS BestMedal
FROM RankedMedals
ORDER BY CountryName ASC;

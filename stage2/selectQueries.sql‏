
-- 1. אתלטים שנולדו אחרי שנת 2000 וזכו במדליה, הצגת המדליה הגבוהה ביותר

WITH RankedMedals AS (
  SELECT 
    a.AthleteID,
    a.AthleteName, 
    a.Gender, 
    c.CountryName,
    DATE_PART('year', AGE(CURRENT_DATE, a.Birthday)) AS Age,
    MAX(CASE 
          WHEN r.Medal = 'Gold' THEN 3
          WHEN r.Medal = 'Silver' THEN 2
          WHEN r.Medal = 'Bronze' THEN 1
        END) AS BestMedalScore
  FROM Athlete a
  JOIN AthleteCompetition r ON a.AthleteID = r.AthleteID
  JOIN Country c ON a.CountryId = c.CountryId
  WHERE EXTRACT(YEAR FROM a.Birthday) > 2000 And r.Medal IS NOT NULL
  GROUP BY a.AthleteID, a.AthleteName, a.Gender, c.CountryName, a.Birthday
)
SELECT 
  AthleteName, 
  Gender, 
  CountryName,
  Age,
  CASE BestMedalScore
    WHEN 3 THEN 'Gold'
    WHEN 2 THEN 'Silver'
    WHEN 1 THEN 'Bronze'
  END AS BestMedal
FROM RankedMedals
ORDER BY CountryName ASC;


-- 2. מספר אתלטים לכל מדינה שהשתתפו בתחרויות כלשהן
SELECT c.CountryName, COUNT(DISTINCT a.AthleteID) AS NumAthletes
FROM Country c
JOIN Athlete a ON c.CountryId = a.CountryId
JOIN AthleteCompetition r ON a.AthleteID = r.AthleteID
GROUP BY c.CountryName
ORDER BY NumAthletes DESC;

-- 3.  כמות כרטיסים לכל אולם בחודש מסוים לפי השנה הנוכחית
SELECT 
  v.VenueName,
  TO_CHAR(t.CardDate, 'YYYY-MM') AS SaleMonth,
  COUNT(*) AS TicketsSold
FROM Ticket t
JOIN Venue v ON t.VenueID = v.VenueID
WHERE EXTRACT(YEAR FROM t.CardDate) = EXTRACT(YEAR FROM CURRENT_DATE)
GROUP BY v.VenueName, SaleMonth
ORDER BY v.VenueName, TicketsSold DESC;


-- 4.  כמות כרטיסים לכל אולם בחודש מסוים לפי כל השנים
SELECT 
  v.VenueName,
  TO_CHAR(t.CardDate, 'FMMonth') AS MonthName,
  EXTRACT(MONTH FROM t.CardDate) AS MonthNumber,
  COUNT(*) AS TicketsSold
FROM Ticket t
JOIN Venue v ON t.VenueID = v.VenueID
GROUP BY v.VenueName, MonthName, MonthNumber
ORDER BY v.VenueName, TicketsSold DESC;

-- 5.  כל ספורט עם מספר תחרויות שבוצעו בו מספר המקומות מספר המדליות

SELECT 
    s.SportName, 
    COUNT(co.CompetitionId) AS NumCompetitions, 
    COUNT(DISTINCT v.VenueName) AS NumVenues,
    COUNT(r.Medal) AS NumMedals,
    MIN(co.CompDate) AS EarliestCompetitionDate
FROM Sport s
LEFT JOIN Competition co ON s.SportID = co.SportID
LEFT JOIN Venue v ON co.VenueID = v.VenueID 
LEFT JOIN AthleteCompetition r ON co.CompetitionId = r.CompetitionId
GROUP BY s.SportName
ORDER BY s.SportName, MIN(co.CompDate);

-- 6.  הספורטאים המובילים מבחינת כמות המדליות שלהם במדינה.
WITH MedalCounts AS (
    SELECT 
        a.AthleteID,
        a.AthleteName,
        c.CountryName,
        a.CountryId,
        COUNT(r.Medal) AS MedalCount
    FROM Athlete a
    JOIN Country c ON a.CountryId = c.CountryId
    JOIN Relationship r ON a.AthleteID = r.AthleteID
    WHERE r.Medal IS NOT NULL
    GROUP BY a.AthleteID, a.AthleteName, c.CountryName, a.CountryId
),
RankedMedals AS (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY CountryId ORDER BY MedalCount DESC, AthleteName) AS rn
    FROM MedalCounts
)
SELECT AthleteName, CountryName, MedalCount
FROM RankedMedals
WHERE rn = 1
ORDER BY CountryName;


-- 7.  האולם הכי פופלארי לכל ספורט.

WITH CompetitionCount AS (
    SELECT 
        Venue.VenueName, 
        Sport.SportName, 
        COUNT(Competition.CompetitionId) AS NumberOfCompetitions
    FROM 
        Competition
    JOIN 
        Sport ON Competition.SportID = Sport.SportID
    JOIN 
        Venue ON Competition.VenueID = Venue.VenueID
    GROUP BY 
        Venue.VenueName, Sport.SportName
)
SELECT 
    SportName, 
    VenueName, 
    NumberOfCompetitions
FROM 
    CompetitionCount
WHERE 
    (SportName, NumberOfCompetitions) IN (
        SELECT 
            SportName, 
            MAX(NumberOfCompetitions)
        FROM 
            CompetitionCount
        GROUP BY 
            SportName
    )
ORDER BY 
    SportName;

-- 8.  אתלטים שהם היחידים מהמדינה שלהם שזכו במדליה.

WITH CountryAthletes AS (
  SELECT 
    c.CountryName, 
    a.AthleteID, 
    a.AthleteName, 
    r.Medal
  FROM Athlete a
  JOIN Country c ON a.CountryId = c.CountryId
  JOIN AthleteCompetition r ON a.AthleteID = r.AthleteID
  WHERE r.Medal IS NOT NULL
),
UniqueCountry AS (
  SELECT 
    ca.CountryName
  FROM CountryAthletes ca
  GROUP BY ca.CountryName
  HAVING COUNT(DISTINCT ca.AthleteID) = 1 
),
RankedMedals AS (
  SELECT 
    ca.AthleteID,
    ca.AthleteName,
    ca.CountryName,
    ca.Medal,
    ROW_NUMBER() OVER (
      PARTITION BY ca.AthleteID 
      ORDER BY 
        CASE ca.Medal 
          WHEN 'Gold' THEN 1 
          WHEN 'Silver' THEN 2 
          WHEN 'Bronze' THEN 3 
          ELSE 4 
        END
    ) AS MedalRank
  FROM CountryAthletes ca
  JOIN UniqueCountry uc ON ca.CountryName = uc.CountryName
)
SELECT AthleteID, AthleteName, CountryName, Medal
FROM RankedMedals
WHERE MedalRank = 1  
ORDER BY AthleteID;
